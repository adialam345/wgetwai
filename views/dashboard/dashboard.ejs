<div class="d-flex justify-content-between align-items-end mb-5">
	<div>
		<h2 class="fw-bold mb-2 text-dark">Dashboard</h2>
		<p class="text-muted mb-0">Manage your WhatsApp sessions and connectivity.</p>
	</div>
	<button class="btn btn-primary btn-minimal shadow-sm" data-bs-toggle="modal" data-bs-target="#createSessionModal">
		<i class="fa-solid fa-plus"></i> New Session
	</button>
</div>

<!-- Sessions Grid -->
<div class="row g-4" id="sessionsGrid">
	<% if (sessions && sessions.length> 0) { %>
		<% sessions.forEach(session=> { %>
			<div class="col-12 col-md-6 col-xl-4" id="card-<%= session.session_name %>">
				<div class="card-simple h-100 d-flex flex-column">
					<div class="d-flex justify-content-between align-items-start mb-4">
						<div class="d-flex align-items-center gap-3">
							<div class="bg-light rounded-circle d-flex align-items-center justify-content-center text-primary"
								style="width: 48px; height: 48px;">
								<i class="fa-brands fa-whatsapp fa-xl"></i>
							</div>
							<div>
								<h5 class="card-title mb-1">
									<%= session.session_name %>
								</h5>
								<p class="text-muted small mb-0 font-monospace">
									<%= session.session_number || 'Not Connected' %>
								</p>
							</div>
						</div>
						<span
							class="status-badge px-2 py-1 rounded <%= session.status === 'CONNECTED' ? 'bg-success-subtle text-success' : 'bg-secondary-subtle text-secondary' %>"
							id="status-<%= session.session_name %>">
							<%= session.status %>
						</span>
					</div>

					<div class="mt-auto d-flex flex-column gap-2">
						<div class="row g-2">
							<div class="col-6">
								<button class="btn btn-outline btn-minimal w-100"
									onclick="openLogModal('<%= session.session_name %>')">
									<i class="fa-solid fa-terminal"></i> Logs
								</button>
							</div>
							<div class="col-6">
								<button class="btn btn-outline btn-minimal w-100"
									onclick="openWebhookModal('<%= session.session_name %>')">
									<i class="fa-solid fa-bolt"></i> Hook
								</button>
							</div>
						</div>

						<div class="d-flex gap-2 mt-2">
							<% if (session.status==='CONNECTED' ) { %>
								<button class="btn btn-danger-subtle btn-minimal flex-grow-1"
									onclick="alertStopSession('<%= session.session_name %>')">
									<i class="fa-solid fa-stop"></i> Stop
								</button>
								<% } else { %>
									<button class="btn btn-primary btn-minimal flex-grow-1"
										onclick="alertStartSession('<%= session.session_name %>')">
										<i class="fa-solid fa-play"></i> Start
									</button>
									<% } %>
										<button class="btn btn-outline btn-minimal text-danger"
											onclick="alertDeleteSession('<%= session.session_name %>')"
											title="Delete Session">
											<i class="fa-solid fa-trash"></i>
										</button>
						</div>
					</div>
				</div>
			</div>
			<% }); %>
				<% } else { %>
					<div class="col-12">
						<div class="card-simple text-center py-5">
							<div class="empty-state-icon">
								<i class="fa-brands fa-whatsapp fa-3x"></i>
							</div>
							<h4 class="fw-bold text-dark mb-2">No Active Sessions</h4>
							<p class="text-muted mb-4" style="max-width: 400px; margin: 0 auto;">You haven't created any
								WhatsApp sessions yet. Create one to start sending messages and managing auto-replies.
							</p>
							<button class="btn btn-primary btn-minimal" data-bs-toggle="modal"
								data-bs-target="#createSessionModal">
								<i class="fa-solid fa-plus"></i> Create First Session
							</button>
						</div>
					</div>
					<% } %>
</div>

<!-- Create Session Modal -->
<div class="modal fade" id="createSessionModal" tabindex="-1">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content border-0 shadow-lg" style="border-radius: var(--radius-lg);">
			<div class="modal-header border-0 pb-0">
				<h5 class="modal-title fw-bold">New Session</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
			</div>
			<div class="modal-body p-4">
				<form action="/session/create-session" method="post">
					<div class="mb-4">
						<label class="form-label">SESSION NAME</label>
						<input type="text" name="session_name" class="form-control" placeholder="e.g. marketing-bot"
							required>
						<div class="form-text mt-2">Use a unique name to identify this connection.</div>
					</div>
					<button class="btn btn-primary btn-minimal w-100 justify-content-center">
						Create & Start Session
					</button>
				</form>
			</div>
		</div>
	</div>
</div>

<!-- QR Modal -->
<div class="modal fade" id="qrModal" tabindex="-1" data-bs-backdrop="static">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content border-0 shadow-lg" style="border-radius: var(--radius-lg);">
			<div class="modal-header border-0">
				<h5 class="modal-title fw-bold">Scan QR Code</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
			</div>
			<div class="modal-body text-center pb-5">
				<div class="mb-3">
					<span class="badge bg-light text-dark border px-3 py-2 rounded-pill" id="qrSessionName">Session:
						-</span>
				</div>
				<div id="qrContainer"
					class="d-flex justify-content-center align-items-center bg-light rounded-4 mx-auto"
					style="width: 280px; height: 280px;">
					<div class="spinner-border text-primary" role="status"></div>
				</div>
				<div class="mt-4">
					<p class="mb-1 fw-bold text-dark">Open WhatsApp on your phone</p>
					<p class="text-muted small">Go to Settings > Linked Devices > Link a Device</p>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Log Modal -->
<div class="modal fade" id="logModal" tabindex="-1">
	<div class="modal-dialog modal-lg modal-dialog-centered">
		<div class="modal-content border-0 shadow-lg" style="border-radius: var(--radius-lg); overflow: hidden;">
			<div class="modal-header border-bottom bg-light">
				<h5 class="modal-title fw-bold">Live Terminal</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
			</div>
			<div class="modal-body p-0 bg-dark">
				<div class="p-3"
					style="height: 450px; overflow-y: auto; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem;"
					id="logContainer">
					<div class="text-secondary">Waiting for logs...</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Webhook Modal -->
<div class="modal fade" id="webhookModal" tabindex="-1">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content border-0 shadow-lg" style="border-radius: var(--radius-lg);">
			<div class="modal-header border-0">
				<h5 class="modal-title fw-bold">Webhook Configuration</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
			</div>
			<div class="modal-body p-4">
				<form id="webhookForm" onsubmit="handleWebhookSubmit(event)">
					<input type="hidden" id="webhookSessionName" name="session_name">
					<div class="mb-3">
						<label class="form-label">CALLBACK URL</label>
						<input type="url" class="form-control" id="webhookUrl" name="callback_url"
							placeholder="https://api.example.com/webhook" required>
					</div>
					<div class="mb-4">
						<label class="form-label">SECRET TOKEN</label>
						<input type="password" class="form-control" id="webhookToken" name="callback_token"
							placeholder="Optional security token">
					</div>
					<div class="d-flex flex-column gap-2">
						<button type="submit" class="btn btn-primary btn-minimal justify-content-center">Save
							Configuration</button>
						<button type="button" class="btn btn-danger-subtle btn-minimal justify-content-center"
							id="btnDeleteWebhook">Remove Webhook</button>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>

<%- include('../layouts/alert') %>

	<script>
		const socket = io();
		let currentLogSession = null;

		// Socket Listeners
		socket.on("connection-status", (event) => {
			updateCardStatus(event.session_name, event.status);
			if (event.status === 'CONNECTED' || event.status === 'ready') {
				const modal = bootstrap.Modal.getInstance(document.getElementById('qrModal'));
				if (modal) modal.hide();
			}
		});

		socket.on(`update-qr`, (event) => {
			const modalEl = document.getElementById('qrModal');
			let modal = bootstrap.Modal.getInstance(modalEl);
			if (!modal) {
				modal = new bootstrap.Modal(modalEl);
				modal.show();
			} else if (!modalEl.classList.contains('show')) {
				modal.show();
			}

			document.getElementById('qrSessionName').innerText = `Session: ${event.session_name}`;
			$("#qrContainer").html(`
				<div class="bg-white p-2 rounded">
					<img src="data:image/png;base64,${event.buffer}" alt="QR Code" style="width: 100%; height: 100%;" />
				</div>
			`);
		});

		socket.on("qr-loading", (event) => {
			const modalEl = document.getElementById('qrModal');
			let modal = bootstrap.Modal.getInstance(modalEl);
			if (!modal) {
				modal = new bootstrap.Modal(modalEl);
				modal.show();
			} else if (!modalEl.classList.contains('show')) {
				modal.show();
			}

			document.getElementById('qrSessionName').innerText = `Session: ${event.session_name}`;
			$("#qrContainer").html(`
				<div class="d-flex flex-column align-items-center">
					<div class="spinner-border text-primary mb-2" role="status"></div>
					<span class="text-muted small">Generating QR...</span>
				</div>
			`);
		});

		socket.on("logger", (event) => {
			if (currentLogSession === event.session_name) {
				const lines = event.result.split("\n").filter(line => line.trim() !== "");
				const html = lines.map(line => `<div class="text-light border-bottom border-secondary py-1" style="border-color: #333 !important;">${line}</div>`).reverse().join("");
				const container = document.getElementById("logContainer");
				container.innerHTML = html;
			}
			if (event.status) {
				updateCardStatus(event.session_name, event.status);
				if (event.status === 'CONNECTED') {
					const modal = bootstrap.Modal.getInstance(document.getElementById('qrModal'));
					if (modal) modal.hide();
				}
			}
		});

		socket.on("session-status", (event) => {
			updateCardStatus(event.session_name, event.status);
			if (event.status === 'CONNECTED') {
				const modal = bootstrap.Modal.getInstance(document.getElementById('qrModal'));
				if (modal) modal.hide();
			}
		});

		function updateCardStatus(sessionName, status) {
			const badge = document.getElementById(`status-${sessionName}`);
			if (badge) {
				badge.className = `status-badge px-2 py-1 rounded ${status === 'CONNECTED' ? 'bg-success-subtle text-success' : 'bg-secondary-subtle text-secondary'}`;
				badge.innerText = status;

				// Reload page if connected to update buttons
				if (status === 'CONNECTED') {
					setTimeout(() => window.location.reload(), 1000);
				}
			}
		}

		// Auto-open QR if requested
		document.addEventListener('DOMContentLoaded', () => {
			const urlParams = new URLSearchParams(window.location.search);
			const session = urlParams.get('session');
			const action = urlParams.get('action');

			if (session && action === 'scan') {
				// Clean URL
				window.history.replaceState({}, document.title, window.location.pathname);
			}
		});

		// Actions
		function alertStartSession(session_name) {
			// Show loading toast instead of modal immediately
			const toast = Swal.mixin({
				toast: true,
				position: 'top-end',
				showConfirmButton: false,
				timer: 3000,
				timerProgressBar: true
			});
			toast.fire({
				icon: 'info',
				title: 'Starting session...'
			});

			fetch(`/session/start-session?session=${session_name}`)
				.then(res => res.json())
				.then(data => {
					if (data.status !== 200) {
						Swal.fire('Error', data.message, 'error');
					}
				});
		}

		function alertStopSession(session_name) {
			Swal.fire({
				title: 'Stop Session?',
				text: "This will disconnect the WhatsApp client.",
				icon: 'warning',
				showCancelButton: true,
				confirmButtonText: 'Stop Session',
				confirmButtonColor: '#ef4444',
				cancelButtonColor: '#64748b'
			}).then((result) => {
				if (result.isConfirmed) {
					fetch(`/session/stop-session?session=${session_name}`)
						.then(res => res.json())
						.then(data => {
							if (data.status === 200) {
								Swal.fire('Stopped', 'Session stopped.', 'success').then(() => window.location.reload());
							} else {
								Swal.fire('Error', data.message, 'error');
							}
						});
				}
			});
		}

		function alertDeleteSession(session_name) {
			Swal.fire({
				title: 'Delete Session?',
				text: "This action cannot be undone.",
				icon: 'warning',
				showCancelButton: true,
				confirmButtonText: 'Delete Permanently',
				confirmButtonColor: '#ef4444',
				cancelButtonColor: '#64748b'
			}).then((result) => {
				if (result.isConfirmed) {
					window.location.href = `/session/delete-session/${session_name}`;
				}
			});
		}

		function openLogModal(session_name) {
			currentLogSession = session_name;
			new bootstrap.Modal(document.getElementById('logModal')).show();
			document.getElementById("logContainer").innerHTML = '<div class="text-secondary p-3">Waiting for live logs...<br><small>Interact with the session to see updates.</small></div>';
		}

		async function openWebhookModal(session_name) {
			document.getElementById('webhookSessionName').value = session_name;
			document.getElementById('webhookUrl').value = '';
			document.getElementById('webhookToken').value = '';

			try {
				const res = await fetch(`/api/callback?session_name=${session_name}`);
				const data = await res.json();
				if (data.status === 200 && data.data) {
					document.getElementById('webhookUrl').value = data.data.callback_url;
					document.getElementById('webhookToken').value = data.data.callback_token || '';
					document.getElementById('btnDeleteWebhook').onclick = () => deleteCallback(session_name);
					document.getElementById('btnDeleteWebhook').style.display = 'block';
				} else {
					document.getElementById('btnDeleteWebhook').style.display = 'none';
				}
			} catch (e) {
				console.error(e);
			}

			new bootstrap.Modal(document.getElementById('webhookModal')).show();
		}

		async function handleWebhookSubmit(event) {
			event.preventDefault();
			const form = event.target;
			const data = {
				session_name: form.session_name.value,
				callback_url: form.callback_url.value,
				callback_token: form.callback_token.value
			};

			fetch("/api/callback", {
				method: "POST",
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify(data)
			})
				.then(res => res.json())
				.then(result => {
					if (result.status === 200) {
						Swal.fire("Saved", "Webhook configuration updated.", "success");
						bootstrap.Modal.getInstance(document.getElementById('webhookModal')).hide();
					} else {
						Swal.fire("Error", result.message, "error");
					}
				});
		}

		async function deleteCallback(sessionName) {
			if (confirm('Remove webhook configuration?')) {
				fetch(`/api/callback/${sessionName}`, { method: "DELETE" })
					.then(res => res.json())
					.then(data => {
						if (data.status === 200) {
							Swal.fire("Removed", "Webhook removed.", "success");
							bootstrap.Modal.getInstance(document.getElementById('webhookModal')).hide();
						}
					});
			}
		}
	</script>