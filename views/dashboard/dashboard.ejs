<style>
	.dashboard-hero {
		background: linear-gradient(120deg, #505a82, #1b9aaa, #6dd5ed);
		color: #fff;
		border: none;
		border-radius: 26px;
		box-shadow: 0 10px 35px rgba(17, 24, 39, 0.35);
		overflow: hidden;
	}
	.dashboard-hero .badge {
		background: rgba(255, 255, 255, 0.2);
		backdrop-filter: blur(6px);
		border-radius: 999px;
		padding: 0.25rem 0.9rem;
		font-weight: 600;
	}
	.metric-pill {
		display: inline-flex;
		align-items: center;
		gap: 0.5rem;
		padding: 0.4rem 0.9rem;
		background: rgba(255, 255, 255, 0.15);
		border-radius: 999px;
		font-size: 0.85rem;
		font-weight: 600;
	}
	.card.glass-card {
		border-radius: 18px;
		border: 1px solid rgba(255, 255, 255, 0.1);
		box-shadow: 0 20px 40px rgba(15, 23, 42, 0.08);
	}
	.card h4 {
		font-weight: 600;
	}
	.divider-text {
		font-weight: 600;
		letter-spacing: 0.08rem;
	}
	#socket-qr {
		min-height: 260px;
	}
	#logger .scroll {
		border-radius: 16px;
	}
	.quick-links a {
		width: 100%;
	}
	.log-terminal {
		background: #0d1117;
		border-radius: 12px;
		padding: 1.25rem;
		font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
		font-size: 0.875rem;
		color: #c9d1d9;
		max-height: 400px;
		overflow-y: auto;
		overflow-x: auto;
		line-height: 1.6;
	}
	.log-terminal::-webkit-scrollbar {
		width: 8px;
		height: 8px;
	}
	.log-terminal::-webkit-scrollbar-track {
		background: #161b22;
		border-radius: 4px;
	}
	.log-terminal::-webkit-scrollbar-thumb {
		background: #30363d;
		border-radius: 4px;
	}
	.log-terminal::-webkit-scrollbar-thumb:hover {
		background: #484f58;
	}
	.log-line {
		margin: 0.25rem 0;
		padding: 0.25rem 0;
		border-left: 3px solid transparent;
		padding-left: 0.75rem;
	}
	.log-line:hover {
		background: rgba(255, 255, 255, 0.05);
		border-left-color: #58a6ff;
	}
	.session-card {
		background: transparent;
		border-radius: 16px;
		padding: 1.5rem;
	}
	.session-info-item {
		display: flex;
		align-items: center;
		gap: 0.75rem;
		padding: 0.75rem;
		background: rgba(0, 0, 0, 0.02);
		border-radius: 10px;
		margin-bottom: 0.75rem;
		border: 1px solid rgba(0, 0, 0, 0.05);
		transition: all 0.2s ease;
	}
	.session-info-item:hover {
		background: rgba(0, 0, 0, 0.04);
		border-color: rgba(0, 0, 0, 0.1);
	}
	.session-info-item i {
		font-size: 1.25rem;
		width: 24px;
		text-align: center;
		color: #bcc8d3;
	}
	.session-info-item .small {
		color: #e5edf3;
		font-size: 0.75rem;
		font-weight: 500;
	}
	.session-info-item .fw-bold {
		color: #a6a7a9;
		font-weight: 600;
		font-size: 0.95rem;
	}
	.session-card {
		color: #212529;
	}
	.status-badge-modern {
		display: inline-flex;
		align-items: center;
		gap: 0.5rem;
		padding: 0.5rem 1rem;
		border-radius: 8px;
		font-weight: 600;
		font-size: 0.875rem;
	}
	.status-badge-modern.connected {
		background: rgba(34, 197, 94, 0.2);
		color: #22c55e;
		border: 1px solid rgba(34, 197, 94, 0.3);
	}
	.status-badge-modern.stopped {
		background: rgba(234, 179, 8, 0.2);
		color: #eab308;
		border: 1px solid rgba(234, 179, 8, 0.3);
	}
</style>
<div class="page-heading d-flex flex-wrap justify-content-between align-items-center gap-2">
	<div>
		<h3 class="mb-1">Control Center</h3>
		<p class="text-muted mb-0">Kelola sesi WhatsApp Gateway, webhook, dan otomatisasi.</p>
	</div>
	<div class="metric-pill text-white bg-primary">
		<i class="fa-solid fa-circle-dot"></i> <span>Gateway Online</span>
	</div>
</div>
<div class="page-content">
	<%- include('../layouts/alert') %>
	<section class="row g-4">
		<div class="col-12">
			<div class="card dashboard-hero p-4">
				<div class="row align-items-center">
					<div class="col-lg-8 col-12">
						<p class="badge mb-3 text-uppercase">WhatsApp Gateway</p>
						<h2 class="fw-bold">WhatsApp Gateway Console</h2>
						<p class="mb-4">Pantau status sesi, kirim pesan, dan sambungkan callback ke n8n melalui satu panel yang bersih dan modern.</p>
						<div class="d-flex flex-wrap gap-2">
							<div class="metric-pill">
								<i class="fa-solid fa-signal"></i>
								<span><%= session ? session.status : 'No session' %></span>
							</div>
							<div class="metric-pill">
								<i class="fa-solid fa-qrcode"></i>
								<span><%= session ? session.session_name : 'Belum ada sesi' %></span>
							</div>
							<a href="/dashboard/api-doc" class="btn btn-light text-primary fw-semibold">
								<i class="fa-solid fa-book me-2"></i>API Docs
							</a>
							<a href="/dashboard/send-message" class="btn btn-outline-light fw-semibold">
								<i class="fa-solid fa-paper-plane me-2"></i>Kirim Pesan
							</a>
						</div>
					</div>
					<div class="col-lg-4 col-12 text-lg-end text-start mt-4 mt-lg-0">
						<p class="text-uppercase small opacity-75 mb-2">Snapshot</p>
						<h4 class="mb-1"><%= session ? session.session_number : 'â€”' %></h4>
						<p class="mb-0 opacity-75">Nomor WhatsApp Tersambung</p>
					</div>
				</div>
			</div>
		</div>

		<div class="col-xl-8 col-12">
			<div class="card glass-card">
				<div class="card-header border-0 pb-0 d-flex justify-content-between align-items-center">
					<div>
						<h4 class="mb-1">Logs Session</h4>
						<p class="text-muted mb-0">Pantau QR dan status terkini.</p>
					</div>
					<div class="divider">
						<div id="cancelqr" class="divider-text text-uppercase small">Create Session <i class="fa-solid fa-arrow-right ms-2"></i></div>
					</div>
				</div>
				<div class="card-body" id="socket-qr">
					<div id="logger">
						<% if (loggerPath) { %>
						<script>
							fetch(`<%= loggerPath %>`)
								.then((res) => res.text())
								.then((data) => appendData(data));
							function appendData(data) {
								var mainContainer = document.getElementById("logger");
								var div = document.createElement("div");
								let c = data.split("\n").filter(line => line.trim() !== "");
								let logLines = c.map((el, index) => {
									return `<div class="log-line">${el}</div>`;
								});

								div.innerHTML = `<div class="log-terminal">${logLines.reverse().join("")}</div>`;
								mainContainer.innerHTML = "";
								mainContainer.appendChild(div);
								// Auto scroll to bottom
								const terminal = div.querySelector('.log-terminal');
								if (terminal) {
									terminal.scrollTop = terminal.scrollHeight;
								}
							}
						</script>
						<% } else { %>
						<div class="text-center text-muted py-5" id="qr-placeholder">
							<i class="fa-solid fa-qrcode fa-2x mb-3"></i>
							<p class="mb-0">Belum ada sesi. Buat sesi baru untuk memulai.</p>
						</div>
						<% } %>
					</div>
				</div>
			</div>
		</div>

		<div class="col-xl-4 col-12">
			<div class="card glass-card">
				<div class="card-header border-0">
					<h4 class="mb-0">Ringkasan Sesi</h4>
				</div>
				<div class="card-body p-0">
					<% if (session) { %>
					<div class="session-card" id="sessionCreate">
						<div class="session-info-item">
							<i class="fa-solid fa-tag"></i>
							<div>
								<div class="small">Nama Sesi</div>
								<div class="fw-bold" id="nameSession"><%= session.session_name %></div>
							</div>
						</div>
						<div class="session-info-item">
							<i class="fa-solid fa-phone"></i>
							<div>
								<div class="small">Nomor WhatsApp</div>
								<div class="fw-bold" id="numberSession"><%= session.session_number || 'Belum terhubung' %></div>
							</div>
						</div>
						<div class="session-info-item">
							<i class="fa-solid fa-circle-dot"></i>
							<div>
								<div class="small">Status</div>
								<div id="statusSession">
									<span class="status-badge-modern <%= session.status === 'CONNECTED' ? 'connected' : 'stopped' %>">
										<i class="fa-solid fa-<%= session.status === 'CONNECTED' ? 'check-circle' : 'clock' %>"></i>
										<%= session.status %>
									</span>
								</div>
							</div>
						</div>
						<div id="buttonSession" class="mt-3">
							<% if (session.status == 'CONNECTED') { %>
							<button class="btn btn-warning w-100 mb-2 fw-semibold" onclick="alertStopSession('<%= session.session_name %>')">
								<i class="fa-solid fa-circle-stop me-2"></i>Stop Session
							</button>
							<% } else { %>
							<button class="btn btn-primary w-100 mb-2 fw-semibold" onclick="alertStartSession('<%= session.session_name %>')">
								<i class="fa-solid fa-play me-2"></i>Start Session
							</button>
							<% } %>
						</div>
						<div id="deleteSession">
							<a href="/session/delete-session/<%= session.session_name %>" class="btn btn-outline-danger w-100 fw-semibold" onclick="return confirm('Yakin hapus sesi ini?')">
								<i class="fa-solid fa-trash-can me-2"></i>Delete Session
							</a>
						</div>
					</div>
					<% } else { %>
					<div class="text-center text-muted py-5" id="sessionCreate">
						<i class="fa-solid fa-inbox fa-2x mb-3 opacity-50"></i>
						<p class="mb-0">Tidak ada sesi aktif</p>
						<p class="small mt-2">Buat sesi baru untuk memulai</p>
					</div>
					<% } %>
				</div>
			</div>
		</div>

		<div class="col-xl-4 col-12">
			<div class="card glass-card">
				<div class="card-header border-0">
					<h4 class="mb-0">Create Session</h4>
				</div>
				<div class="card-body">
					<form action="/session/create-session" method="post" class="needs-validation" novalidate>
						<div class="form-group mb-3">
							<label class="form-label">Session Name</label>
							<input type="text" name="session_name" class="form-control form-control-lg" placeholder="contoh: session_finance" required />
						</div>
						<button class="btn btn-primary w-100">
							<i class="fa-solid fa-qrcode me-2"></i>Create &amp; Scan
						</button>
					</form>
				</div>
			</div>
		</div>

		<div class="col-xl-4 col-12">
			<div class="card glass-card">
				<div class="card-header border-0 d-flex justify-content-between align-items-center">
					<h4 class="mb-0">Callback Webhook</h4>
					<span class="badge bg-light text-dark"><i class="fa-solid fa-plug"></i></span>
				</div>
				<div class="card-body">
					<% if (session) { %>
					<form id="callbackForm" onsubmit="handleCallbackSubmit(event)">
						<input type="hidden" name="session_name" value="<%= session.session_name %>" />
						<div class="form-group mb-3">
							<label class="form-label">Callback URL</label>
							<input type="url" class="form-control" name="callback_url" placeholder="https://..." value="<%= callbackSetting ? callbackSetting.callback_url : '' %>" required />
						</div>
						<div class="form-group mb-3">
							<label class="form-label">Callback Token (Optional)</label>
							<input type="text" class="form-control" name="callback_token" placeholder="x-api-key value" value="<%= callbackSetting ? callbackSetting.callback_token || '' : '' %>" />
						</div>
						<button class="btn btn-primary w-100" type="submit">
							<i class="fa-solid fa-floppy-disk me-2"></i>Save Callback
						</button>
						<% if (callbackSetting) { %>
						<button class="btn btn-outline-danger w-100 mt-2" type="button" onclick="deleteCallback('<%= session.session_name %>')">
							<i class="fa-solid fa-trash me-2"></i>Remove Callback
						</button>
						<% } %>
						<p class="text-muted mt-3 mb-0 small">
							Callback per sesi akan menimpa `N8N_WEBHOOK_URL`. Pastikan URL dapat diakses server ini.
						</p>
					</form>
					<% } else { %>
					<p class="text-center mb-0 text-muted">Buat sesi terlebih dahulu untuk mengatur callback webhook.</p>
					<% } %>
				</div>
			</div>
		</div>

		<div class="col-xl-4 col-12">
			<div class="card glass-card">
				<div class="card-header border-0">
					<h4 class="mb-0">Quick Links</h4>
				</div>
				<div class="card-body quick-links">
					<a href="/dashboard/send-message" class="btn btn-outline-primary mb-2">
						<i class="fa-solid fa-comments me-2"></i>Send Message
					</a>
					<a href="/dashboard/history-message" class="btn btn-outline-primary mb-2">
						<i class="fa-solid fa-clock-rotate-left me-2"></i>History
					</a>
					<a href="/dashboard/auto-reply" class="btn btn-outline-primary mb-2">
						<i class="fa-solid fa-robot me-2"></i>Auto Reply
					</a>
					<a href="/dashboard/api-doc" class="btn btn-outline-primary">
						<i class="fa-solid fa-code me-2"></i>API Docs
					</a>
				</div>
			</div>
		</div>
	</section>
</div>

<footer class="mt-5">
	<div class="divider">
		<div class="divider-text">
			<p class="mb-0 small text-muted">WhatsApp Gateway Console &copy; <%= new Date().getFullYear() %></p>
		</div>
	</div>
</footer>

<script>
	const socket = io.connect(`<%= process.env.HOST %>`);

	socket.on("connection-status", (event) => {
		$("#cancelqr").html(`Alert Status!`);
		if (event.result) {
			$("#socket-qr").html(`<center><p>${event.result}</p></center>`);
		}
	});

	socket.on(`update-qr`, (event) => {
		// $("#cancelqr").html(`<a href="/session/cancelqr?id=${event.session_name}" style="text-align: center" class="btn btn-danger"><i class="fas fa-ban"></i>&nbsp Cancel QR</a>`);
		$("#socket-qr").html(`<center><img class="img-fluid" src="data:image/png;base64,${event.buffer}" alt="" /></center>`);
		$("#qr-placeholder").remove();
	});

	socket.on("qr-loading", (event) => {
		const text =
			event.message ||
			(event.status === "WAITING_MANUAL"
				? `Menunggu tindakan. Tekan tombol <strong>Generate QR</strong> untuk sesi <strong>${event.session_name}</strong>.`
				: `Menyiapkan QR untuk <strong>${event.session_name}</strong>...`);
		$("#socket-qr").html(
			`<div class="text-center text-muted py-5">
				<div class="spinner-border text-primary mb-3" role="status"></div>
				<p class="mb-0">${text}</p>
			</div>`
		);
	});

	socket.on("logger", (event) => {
		let c = event.result.split("\n").filter(line => line.trim() !== "");
		let logLines = c.map((el, index) => {
			return `<div class="log-line">${el}</div>`;
		});
		let hasil = logLines.reverse().join("");
		$("#cancelqr").html(`Create Session &nbsp;&nbsp;<i class="fa-solid fa-arrow-right"></i>`);
		$("#socket-qr").html(`<div class="log-terminal">${hasil}</div>`);
		// Auto scroll to bottom
		setTimeout(() => {
			const terminal = document.querySelector('.log-terminal');
			if (terminal) {
				terminal.scrollTop = terminal.scrollHeight;
			}
		}, 100);
		
		const statusClass = event.status === 'CONNECTED' ? 'connected' : 'stopped';
		const statusIcon = event.status === 'CONNECTED' ? 'check-circle' : 'clock';
		const buttonHtml = event.status === 'CONNECTED' 
			? `<button class="btn btn-warning w-100 mb-2 fw-semibold" onclick="alertStopSession('${event.session_name}')"><i class="fa-solid fa-circle-stop me-2"></i>Stop Session</button>`
			: `<button class="btn btn-primary w-100 mb-2 fw-semibold" onclick="alertStartSession('${event.session_name}')"><i class="fa-solid fa-play me-2"></i>Start Session</button>`;
		
		$("#sessionCreate").html(
			`<div class="session-info-item">
				<i class="fa-solid fa-tag"></i>
				<div>
					<div class="small opacity-75">Nama Sesi</div>
					<div class="fw-bold" id="nameSession">${event.session_name}</div>
				</div>
			</div>
			<div class="session-info-item">
				<i class="fa-solid fa-phone"></i>
				<div>
					<div class="small opacity-75">Nomor WhatsApp</div>
					<div class="fw-bold" id="numberSession">${event.session_number || 'Belum terhubung'}</div>
				</div>
			</div>
			<div class="session-info-item">
				<i class="fa-solid fa-circle-dot"></i>
				<div>
					<div class="small opacity-75">Status</div>
					<div id="statusSession">
						<span class="status-badge-modern ${statusClass}">
							<i class="fa-solid fa-${statusIcon}"></i>
							${event.status}
						</span>
					</div>
				</div>
			</div>
			<div id="buttonSession" class="mt-3">
				${buttonHtml}
			</div>
			<div id="deleteSession">
				<a href="/session/delete-session/${event.session_name}" class="btn btn-outline-danger w-100 fw-semibold" onclick="return confirm('Yakin hapus sesi ini?')">
					<i class="fa-solid fa-trash-can me-2"></i>Delete Session
				</a>
			</div>`
		);
	});

	socket.on(`session-status`, (event) => {
		const statusClass = event.status === 'CONNECTED' ? 'connected' : 'stopped';
		const statusIcon = event.status === 'CONNECTED' ? 'check-circle' : 'clock';
		$("#statusSession").html(
			`<span class="status-badge-modern ${statusClass}">
				<i class="fa-solid fa-${statusIcon}"></i>
				${event.status}
			</span>`
		);
		if (event.status == "CONNECTED") {
			$("#buttonSession").html(
				`<button class="btn btn-warning w-100 mb-2 fw-semibold" onclick="alertStopSession('${event.session_name}')"><i class="fa-solid fa-circle-stop me-2"></i>Stop Session</button>`
			);
		} else if (event.status == "STOPPED") {
			$("#buttonSession").html(
				`<button class="btn btn-primary w-100 mb-2 fw-semibold" onclick="alertStartSession('${event.session_name}')"><i class="fa-solid fa-play me-2"></i>Start Session</button>`
			);
		}
	});

	async function alertStartSession(session_name) {
		Swal.fire({
			title: `Start Session`,
			html: `Are You Sure Start Session ${session_name}?`,
			icon: "question",
			confirmButtonText: `Start Session`,
			showLoaderOnConfirm: true,
			preConfirm: () => {
				return fetch(`/session/start-session?session=${session_name}`)
					.then((response) => {
						if (!response.ok) {
							throw new Error(response.statusText);
						}
						return response.json();
					})
					.catch((error) => {
						Swal.showValidationMessage(`Request failed: ${error}!`);
					});
			},
		}).then((result) => {
			if (result.isConfirmed) {
				if (result.value.status == 200) {
					Swal.fire("Success!", JSON.stringify(result.value.message), "success");
				} else {
					Swal.fire(`Status ${result.value.status}`, JSON.stringify(result.value.message), "error");
				}
			}
		});
	}

	async function alertStopSession(session_name) {
		Swal.fire({
			title: `Stop Session`,
			html: `Are You Sure Stop Session ${session_name}?`,
			icon: "question",
			confirmButtonText: `Stop Session`,
			showLoaderOnConfirm: true,
			preConfirm: () => {
				return fetch(`/session/stop-session?session=${session_name}`)
					.then((response) => {
						if (!response.ok) {
							throw new Error(response.statusText);
						}
						return response.json();
					})
					.catch((error) => {
						Swal.showValidationMessage(`Request failed: ${error}!`);
					});
			},
		}).then((result) => {
			if (result.isConfirmed) {
				if (result.value.status == 200) {
					Swal.fire("Success!", JSON.stringify(result.value.message), "success");
				} else {
					Swal.fire(`Status ${result.value.status}`, JSON.stringify(result.value.message), "error");
				}
			}
		});
	}

	async function handleCallbackSubmit(event) {
		event.preventDefault();
		const form = event.target;
		const sessionName = form.session_name.value.trim();
		const callbackUrl = form.callback_url.value.trim();
		const callbackToken = form.callback_token.value.trim();

		if (!callbackUrl) {
			return Swal.fire("Validasi", "Callback URL tidak boleh kosong", "warning");
		}

		try {
			const response = await fetch("/api/callback", {
				method: "POST",
				headers: {
					"Content-Type": "application/json",
				},
				body: JSON.stringify({
					session_name: sessionName,
					callback_url: callbackUrl,
					callback_token: callbackToken || undefined,
				}),
			});
			const result = await response.json();
			if (result.status === 200) {
				Swal.fire("Berhasil", "Callback webhook tersimpan", "success").then(() => window.location.reload());
			} else {
				Swal.fire(`Status ${result.status}`, JSON.stringify(result.message), "error");
			}
		} catch (error) {
			Swal.fire("Error", error.message, "error");
		}
	}

	async function deleteCallback(sessionName) {
		Swal.fire({
			title: "Hapus Callback",
			html: `Hapus callback untuk sesi <strong>${sessionName}</strong>?`,
			icon: "warning",
			showCancelButton: true,
			confirmButtonText: "Hapus",
		}).then(async (result) => {
			if (!result.isConfirmed) return;
			try {
				const response = await fetch(`/api/callback/${sessionName}`, { method: "DELETE" });
				const value = await response.json();
				if (value.status === 200) {
					Swal.fire("Berhasil", "Callback dihapus", "success").then(() => window.location.reload());
				} else {
					Swal.fire(`Status ${value.status}`, JSON.stringify(value.message), "error");
				}
			} catch (error) {
				Swal.fire("Error", error.message, "error");
			}
		});
	}

</script>
