<div class="page-heading d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4">
	<div class="animate-fade-in">
		<h3 class="mb-1 fw-bold">Message History</h3>
		<p class="text-muted mb-0">Archive of all processed messages.</p>
	</div>
	<nav aria-label="breadcrumb" class="animate-fade-in" style="animation-delay: 0.1s;">
		<ol class="breadcrumb mb-0">
			<li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
			<li class="breadcrumb-item active" aria-current="page">History</li>
		</ol>
	</nav>
</div>

<div class="page-content">
	<%- include('../layouts/alert') %>

		<section class="animate-fade-in" style="animation-delay: 0.2s;">
			<div class="card glass-card">
				<div class="card-header border-0 d-flex flex-wrap justify-content-between align-items-center gap-3">
					<div>
						<h5 class="card-title mb-1">Sent Messages</h5>
						<p class="text-muted mb-0 small">View and manage your message history.</p>
					</div>
					<button onclick="alertDeleteAllHistory()" class="btn btn-outline-danger" data-bs-toggle="tooltip"
						title="Clear All History">
						<i class="fa-solid fa-trash-can me-2"></i>Clear History
					</button>
				</div>
				<div class="card-body">
					<div class="table-responsive rounded-3 border">
						<table class="table table-hover mb-0" id="table1">
							<thead class="bg-light">
								<tr>
									<th class="px-4 py-3">Date</th>
									<th class="px-4 py-3">Session</th>
									<th class="px-4 py-3">Type</th>
									<th class="px-4 py-3">Target</th>
									<th class="px-4 py-3">Message</th>
									<th class="px-4 py-3 text-end">Action</th>
								</tr>
							</thead>
							<tbody>
								<% if (Array.isArray(db) && db.length) { %>
									<% db.forEach((el, index)=> { %>
										<tr>
											<td class="px-4 align-middle text-nowrap"><span class="text-muted small">
													<%= el.date %>
												</span></td>
											<td class="px-4 align-middle">
												<span class="fw-medium text-dark">
													<%= el.session_name %>
												</span>
											</td>
											<td class="px-4 align-middle">
												<span
													class="badge bg-light text-info border border-info-subtle px-2 py-1 rounded-pill text-uppercase"
													style="font-size: 0.7rem;">
													<%= el.type %>
												</span>
											</td>
											<td class="px-4 align-middle font-monospace small">
												<%= el.target %>
											</td>
											<td class="px-4 align-middle text-truncate" style="max-width: 250px;">
												<span class="text-muted">
													<%= el.caption %>
												</span>
											</td>
											<td class="px-4 align-middle text-end">
												<button onclick="alertDeleteHistory('<%= el.id %>')"
													class="btn btn-sm btn-light text-danger" title="Delete">
													<i class="fa-solid fa-trash-can"></i>
												</button>
											</td>
										</tr>
										<% }); %>
											<% } else { %>
												<tr>
													<td colspan="6" class="text-center py-5 text-muted">
														<i
															class="fa-solid fa-clock-rotate-left fa-2x mb-3 opacity-25"></i>
														<p class="mb-0">No message history found.</p>
													</td>
												</tr>
												<% } %>
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</section>
</div>

<footer class="mt-5 mb-4">
	<div class="text-center">
		<p class="mb-0 small text-muted">WhatsApp Gateway Console &copy; <%= new Date().getFullYear() %>
		</p>
	</div>
</footer>

<script src="/assets/extensions/jquery/jquery.min.js"></script>
<script src="https://cdn.datatables.net/v/bs5/dt-1.12.1/datatables.min.js"></script>
<script src="/assets/js/pages/datatables.js"></script>

<script>
	const swalConfig = {
		customClass: {
			confirmButton: 'btn btn-primary me-2',
			cancelButton: 'btn btn-light',
			popup: 'glass-card border-0'
		},
		buttonsStyling: false
	};

	async function alertDeleteHistory(id) {
		Swal.fire({
			...swalConfig,
			title: 'Delete Record',
			text: "Are you sure you want to delete this history record?",
			icon: "warning",
			showCancelButton: true,
			confirmButtonText: 'Delete',
			customClass: {
				confirmButton: 'btn btn-danger me-2',
				cancelButton: 'btn btn-light'
			},
			preConfirm: () => {
				return fetch(`/api/del-history?id=${id}`)
					.then(res => {
						if (!res.ok) throw new Error(res.statusText);
						return res.json();
					})
					.catch(error => Swal.showValidationMessage(`Request failed: ${error}`));
			}
		}).then((result) => {
			if (result.isConfirmed) {
				if (result.value.status == 200) {
					Swal.fire({ ...swalConfig, icon: 'success', title: 'Deleted!', text: result.value.message })
						.then(() => window.location = "/dashboard/history-message");
				} else {
					Swal.fire({ ...swalConfig, icon: 'error', title: 'Error', text: result.value.message });
				}
			}
		});
	}

	async function alertDeleteAllHistory() {
		Swal.fire({
			...swalConfig,
			title: 'Clear History',
			text: "Are you sure you want to delete ALL history? This cannot be undone.",
			icon: "warning",
			showCancelButton: true,
			confirmButtonText: 'Clear All',
			customClass: {
				confirmButton: 'btn btn-danger me-2',
				cancelButton: 'btn btn-light'
			},
			preConfirm: () => {
				return fetch(`/api/delall-history`)
					.then(res => {
						if (!res.ok) throw new Error(res.statusText);
						return res.json();
					})
					.catch(error => Swal.showValidationMessage(`Request failed: ${error}`));
			}
		}).then((result) => {
			if (result.isConfirmed) {
				if (result.value.status == 200) {
					Swal.fire({ ...swalConfig, icon: 'success', title: 'Cleared!', text: result.value.message })
						.then(() => window.location = "/dashboard/history-message");
				} else {
					Swal.fire({ ...swalConfig, icon: 'error', title: 'Error', text: result.value.message });
				}
			}
		});
	}
</script>