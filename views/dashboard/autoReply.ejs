<div class="page-heading d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4">
	<div class="animate-fade-in">
		<h3 class="mb-1 fw-bold">Auto Reply</h3>
		<p class="text-muted mb-0">Configure automatic responses based on keywords.</p>
	</div>
	<nav aria-label="breadcrumb" class="animate-fade-in" style="animation-delay: 0.1s;">
		<ol class="breadcrumb mb-0">
			<li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
			<li class="breadcrumb-item active" aria-current="page">Auto Reply</li>
		</ol>
	</nav>
</div>

<div class="page-content">
	<%- include('../layouts/alert') %>

		<section class="animate-fade-in" style="animation-delay: 0.2s;">
			<div class="card glass-card">
				<div class="card-header border-0 d-flex flex-wrap justify-content-between align-items-center gap-3">
					<div>
						<h5 class="card-title mb-1">Keyword Responses</h5>
						<p class="text-muted mb-0 small">Manage your auto-reply rules here.</p>
					</div>
					<div class="d-flex gap-2">
						<button onclick="alertKeywordAutoReply(true)" class="btn btn-primary">
							<i class="fa-solid fa-plus me-2"></i>Add Keyword
						</button>
						<button onclick="alertDeleteAllKeyword()" class="btn btn-outline-danger"
							data-bs-toggle="tooltip" title="Delete All Keywords">
							<i class="fa-solid fa-trash-can"></i>
						</button>
					</div>
				</div>
				<div class="card-body">
					<div class="table-responsive rounded-3 border">
						<table class="table table-hover mb-0" id="table1">
							<thead class="bg-light">
								<tr>
									<th class="px-4 py-3">Date</th>
									<th class="px-4 py-3">Session</th>
									<th class="px-4 py-3">Keyword</th>
									<th class="px-4 py-3">Response</th>
									<th class="px-4 py-3 text-end">Action</th>
								</tr>
							</thead>
							<tbody>
								<% if (Array.isArray(replyList) && replyList.length) { %>
									<% replyList.forEach((el, index)=> { %>
										<tr>
											<td class="px-4 align-middle"><span class="text-muted small">
													<%= el.date %>
												</span></td>
											<td class="px-4 align-middle">
												<div class="d-flex flex-column">
													<span class="fw-bold text-dark">
														<%= el.session_name %>
													</span>
													<span class="small text-muted font-monospace">
														<%= el.session_number %>
													</span>
												</div>
											</td>
											<td class="px-4 align-middle">
												<span
													class="badge bg-light text-primary border border-primary-subtle px-3 py-2 rounded-pill">
													<%= el.keyword %>
												</span>
											</td>
											<td class="px-4 align-middle text-truncate" style="max-width: 300px;">
												<%= el.response %>
											</td>
											<td class="px-4 align-middle text-end">
												<button
													onclick="alertKeywordAutoReply(false, '<%= el.session_number %>', '<%= el.keyword %>', '<%= el.response %>')"
													class="btn btn-sm btn-light text-primary me-1" title="Edit">
													<i class="fa-solid fa-pen-to-square"></i>
												</button>
												<button
													onclick="alertDeleteAutoReply('<%= el.session_number %>', '<%= el.keyword %>')"
													class="btn btn-sm btn-light text-danger" title="Delete">
													<i class="fa-solid fa-trash-can"></i>
												</button>
											</td>
										</tr>
										<% }); %>
											<% } else { %>
												<tr>
													<td colspan="5" class="text-center py-5 text-muted">
														<i class="fa-solid fa-robot fa-2x mb-3 opacity-25"></i>
														<p class="mb-0">No auto-reply rules found.</p>
													</td>
												</tr>
												<% } %>
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</section>
</div>

<footer class="mt-5 mb-4">
	<div class="text-center">
		<p class="mb-0 small text-muted">WhatsApp Gateway Console &copy; <%= new Date().getFullYear() %>
		</p>
	</div>
</footer>

<script src="/assets/extensions/jquery/jquery.min.js"></script>
<script src="https://cdn.datatables.net/v/bs5/dt-1.12.1/datatables.min.js"></script>
<script src="/assets/js/pages/datatables.js"></script>

<script>
	const swalConfig = {
		customClass: {
			confirmButton: 'btn btn-primary me-2',
			cancelButton: 'btn btn-light',
			popup: 'glass-card border-0'
		},
		buttonsStyling: false
	};

	async function alertDeleteAutoReply(session_number, keyword) {
		Swal.fire({
			...swalConfig,
			title: 'Delete Rule',
			text: `Delete auto-reply for keyword "${keyword}"?`,
			icon: "warning",
			showCancelButton: true,
			confirmButtonText: 'Delete',
			customClass: {
				confirmButton: 'btn btn-danger me-2',
				cancelButton: 'btn btn-light'
			},
			preConfirm: () => {
				return fetch(`/reply/delete-reply?session=${session_number}&keyword=${keyword}`)
					.then(res => {
						if (!res.ok) throw new Error(res.statusText);
						return res.json();
					})
					.catch(error => Swal.showValidationMessage(`Request failed: ${error}`));
			}
		}).then((result) => {
			if (result.isConfirmed) {
				if (result.value.status == 200) {
					Swal.fire({ ...swalConfig, icon: 'success', title: 'Deleted!', text: result.value.message })
						.then(() => window.location = "/dashboard/auto-reply");
				} else {
					Swal.fire({ ...swalConfig, icon: 'error', title: 'Error', text: result.value.message });
				}
			}
		});
	}

	async function alertDeleteAllKeyword() {
		Swal.fire({
			...swalConfig,
			title: 'Delete All Rules',
			text: "Are you sure you want to delete ALL auto-reply keywords? This cannot be undone.",
			icon: "warning",
			showCancelButton: true,
			confirmButtonText: 'Delete All',
			customClass: {
				confirmButton: 'btn btn-danger me-2',
				cancelButton: 'btn btn-light'
			},
			preConfirm: () => {
				return fetch(`/reply/deleteall-reply`)
					.then(res => {
						if (!res.ok) throw new Error(res.statusText);
						return res.json();
					})
					.catch(error => Swal.showValidationMessage(`Request failed: ${error}`));
			}
		}).then((result) => {
			if (result.isConfirmed) {
				if (result.value.status == 200) {
					Swal.fire({ ...swalConfig, icon: 'success', title: 'Deleted!', text: result.value.message })
						.then(() => window.location = "/dashboard/auto-reply");
				} else {
					Swal.fire({ ...swalConfig, icon: 'error', title: 'Error', text: result.value.message });
				}
			}
		});
	}

	function alertKeywordAutoReply(add, session, keyword, respon) {
		const isEdit = !add;
		const title = isEdit ? "Edit Auto Reply" : "New Auto Reply";
		const btnText = isEdit ? "Save Changes" : "Create Rule";

		const htmlSwal = `
			<div class="text-start">
				<div class="form-group mb-3">
					<label class="form-label small fw-bold text-muted">SESSION</label>
					${add ? `
					<select id="sessionId" class="form-select">
						<% if (Array.isArray(session) && session.length) { %> 
							<% session.forEach((el) => { %> <option value="<%= el.session_name %> (+<%= el.session_number %>)"><%= el.session_name %> (+<%= el.session_number %>)</option> <% }) %> 
						<% } %>
					</select>` :
				`<input type="text" class="form-control" value="${session}" disabled readonly />`
			}
				</div>
				<div class="form-group mb-3">
					<label class="form-label small fw-bold text-muted">KEYWORD</label>
					<input id="keywordId" type="text" class="form-control" placeholder="e.g. hello" value="${keyword || ''}" />
				</div>
				<div class="form-group mb-0">
					<label class="form-label small fw-bold text-muted">RESPONSE</label>
					<textarea id="responId" class="form-control" rows="3" placeholder="Response message...">${respon || ''}</textarea>
				</div>
			</div>
		`;

		Swal.fire({
			...swalConfig,
			title: title,
			html: htmlSwal,
			showCancelButton: true,
			confirmButtonText: btnText,
			preConfirm: () => {
				const keywordVal = document.getElementById("keywordId").value;
				const responVal = document.getElementById("responId").value;

				if (!keywordVal || !responVal) {
					Swal.showValidationMessage('Keyword and Response are required');
					return false;
				}

				let endpoint = add ? 'create-reply' : 'edit-reply';
				let data;

				if (add) {
					data = {
						session: document.getElementById("sessionId").value,
						keyword: keywordVal,
						respon: responVal
					};
				} else {
					data = {
						session: session,
						keyword: keyword,
						newKeyword: keywordVal,
						newRespon: responVal
					};
				}

				return fetch(`/reply/${endpoint}`, {
					method: "POST",
					body: JSON.stringify(data),
					headers: { "Content-Type": "application/json" }
				})
					.then(res => {
						if (!res.ok) throw new Error(res.statusText);
						return res.json();
					})
					.catch(error => Swal.showValidationMessage(`Request failed: ${error}`));
			}
		}).then((result) => {
			if (result.isConfirmed) {
				Swal.fire({ ...swalConfig, icon: 'success', title: 'Success', text: 'Auto reply rule saved successfully' })
					.then(() => window.location = "/dashboard/auto-reply");
			}
		});
	}
</script>